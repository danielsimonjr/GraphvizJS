{
  "phase": 3,
  "sprint": 2,
  "title": "Auto-Save / Recovery",
  "priority": "MEDIUM",
  "effort": "45 minutes",
  "status": "completed",
  "startedAt": "2026-01-27",
  "completedAt": "2026-01-27",
  "implementationNotes": "Created autosave/constants.ts with shared store keys and config. Created autosave/manager.ts with setupAutosave (30s interval, content-change detection), saveDraft, and clearDraft. Created autosave/recovery.ts with checkForRecovery, promptRecovery (Tauri confirm dialog), and cleanupStaleDrafts (hardcoded 7-day threshold). Wired into main.ts bootstrap: recovery check before editor focus, autosave after toolbar setup, clearDraft on commitDocument with saved flag, clearDraft on new diagram via onNew callback. Draft cleared on both accept and decline to prevent repeated prompts. lastSavedAt comparison not needed because clearDraft is called on every manual save. 21 new unit tests (10 manager + 11 recovery). Task 3.2.4 handled via commitDocument in main.ts rather than modifying save-diagram.ts directly.",
  "impact": "Prevents data loss by periodically saving drafts and recovering unsaved work after crashes",
  "targetMetrics": {
    "autosave": {
      "current": "No auto-save; unsaved work lost on crash",
      "target": "Drafts saved every 30s; recovery prompt on startup"
    }
  },
  "tasks": [
    {
      "id": "3.2.1",
      "category": "core",
      "title": "Create autosave manager",
      "description": "Create src/autosave/manager.ts to handle periodic draft saving. Uses the existing debounce utility and Tauri Store API. Saves editor content to a 'draftContent' key in the settings store every 30 seconds when content has changed. Tracks a 'draftTimestamp' and 'draftFilePath' alongside the content.",
      "status": "completed",
      "implementationNotes": "Created manager.ts with setupAutosave (returns cleanup fn), saveDraft, clearDraft. Uses setInterval (not debounce) for 30s polling with content-change detection. Shared constants extracted to constants.ts.",
      "estimatedHours": 0.25,
      "files": ["src/autosave/manager.ts", "src/autosave/constants.ts"],
      "testCategories": ["typecheck", "unit"],
      "acceptanceCriteria": [
        "Exports setupAutosave(options) function",
        "Saves draft content to Tauri store on debounced interval (30s)",
        "Only saves when content has changed since last autosave",
        "Stores draftContent, draftTimestamp, and draftFilePath keys",
        "Exports clearDraft() to remove recovery data after manual save",
        "pnpm typecheck passes"
      ]
    },
    {
      "id": "3.2.2",
      "category": "core",
      "title": "Create recovery module",
      "description": "Create src/autosave/recovery.ts to check for and restore unsaved drafts on startup. Reads draftContent/draftTimestamp/draftFilePath from the Tauri store. If a draft exists and is newer than 'lastSavedAt', prompts the user to recover or discard. Handles cleanup of stale drafts older than 7 days.",
      "status": "completed",
      "implementationNotes": "Created recovery.ts with checkForRecovery (reads store, checks staleness), promptRecovery (Tauri confirm dialog), cleanupStaleDrafts (hardcoded 7-day max age via constant). Does not compare against lastSavedAt; staleness is draft-age-only since clearDraft on save prevents stale drafts.",
      "estimatedHours": 0.25,
      "files": ["src/autosave/recovery.ts"],
      "testCategories": ["typecheck", "unit"],
      "acceptanceCriteria": [
        "Exports checkForRecovery(store) function returning recovery data or null",
        "Exports promptRecovery(data) function that shows confirm dialog",
        "Exports cleanupStaleDrafts(store) function (max age hardcoded via MAX_DRAFT_AGE_DAYS constant)",
        "Returns null if no draft or draft is older than 7 days",
        "Uses @tauri-apps/plugin-dialog for confirm prompt",
        "pnpm typecheck passes"
      ]
    },
    {
      "id": "3.2.3",
      "category": "core",
      "title": "Wire up autosave in main.ts",
      "description": "Integrate autosave manager and recovery module into main.ts bootstrap flow. On startup: check for recovery, prompt user, then start autosave. On manual save: clear draft. On new diagram: clear draft and reset autosave.",
      "status": "completed",
      "implementationNotes": "Wired recovery check before editor.focus(), autosave setup after toolbar init. clearDraft called on commitDocument({saved:true}) and on new diagram via onNew callback. Draft cleared on both accept and decline to prevent repeated prompts. setupAutosave return value captured for future cleanup use. status.success used for auto-reverting 'Draft saved' indicator.",
      "estimatedHours": 0.15,
      "files": ["src/main.ts"],
      "testCategories": ["typecheck", "manual"],
      "acceptanceCriteria": [
        "checkForRecovery called during bootstrap before editor focus",
        "If recovery accepted, editor content replaced with draft",
        "setupAutosave called after editor initialization",
        "commitDocument triggers clearDraft when saved",
        "New diagram action resets autosave state",
        "pnpm typecheck passes"
      ]
    },
    {
      "id": "3.2.4",
      "category": "core",
      "title": "Clear drafts on save",
      "description": "After a successful manual save, call clearDraft() to remove the recovery data from the store. This prevents stale recovery prompts on next startup.",
      "status": "completed",
      "implementationNotes": "Handled via commitDocument({saved:true}) in main.ts rather than modifying save-diagram.ts directly. The save action calls commitDocument with saved flag, which triggers clearDraft. This centralizes draft management in main.ts.",
      "estimatedHours": 0.05,
      "files": ["src/main.ts"],
      "testCategories": ["typecheck", "manual"],
      "acceptanceCriteria": [
        "clearDraft called after successful writeTextFile",
        "No recovery prompt after clean save and restart",
        "pnpm typecheck passes"
      ]
    },
    {
      "id": "3.2.5",
      "category": "ui",
      "title": "Add autosave status indicator",
      "description": "Show a subtle status indicator in the footer when autosave occurs. Use the existing status controller pattern (status.info or status.success). Display 'Draft saved' briefly after each autosave.",
      "status": "completed",
      "implementationNotes": "Uses status.success('Draft saved') which auto-reverts after 4 seconds via the setStatus autoRevert mechanism in createStatusController.",
      "estimatedHours": 0.05,
      "files": ["src/main.ts"],
      "testCategories": ["manual"],
      "acceptanceCriteria": [
        "Status bar briefly shows 'Draft saved' after autosave",
        "Does not overwrite error or rendering status messages",
        "Subtle and non-distracting"
      ]
    },
    {
      "id": "3.2.6",
      "category": "testing",
      "title": "Add unit tests for autosave manager",
      "description": "Create test/autosave/manager.test.ts with tests covering: setup, debounced saving, content-change detection, clearDraft, and store interaction. Mock Tauri store API.",
      "status": "completed",
      "implementationNotes": "10 tests covering setupAutosave (returns cleanup, saves after interval, skips unchanged, calls onDraftSaved, handles errors, stops after cleanup), saveDraft (all keys, null filePath), clearDraft (deletes keys, handles errors). Uses vi.useFakeTimers for interval control.",
      "estimatedHours": 0.2,
      "files": ["test/autosave/manager.test.ts"],
      "testCategories": ["unit"],
      "acceptanceCriteria": [
        "Tests for setupAutosave initialization",
        "Tests for debounced draft saving",
        "Tests that unchanged content is not re-saved",
        "Tests for clearDraft removing store keys",
        "Tests for store.set and store.save calls",
        "80%+ coverage"
      ]
    },
    {
      "id": "3.2.7",
      "category": "testing",
      "title": "Add unit tests for recovery module",
      "description": "Create test/autosave/recovery.test.ts with tests covering: no draft found, valid draft recovery, stale draft cleanup (>7 days), user accepts/declines recovery, and error handling.",
      "status": "completed",
      "implementationNotes": "11 tests covering checkForRecovery (no draft, valid draft, null filePath, stale >7d cleanup, missing timestamp, store error), promptRecovery (accept, decline, confirm message), cleanupStaleDrafts (deletes keys, handles errors). Uses dynamic imports with vi.resetModules.",
      "estimatedHours": 0.2,
      "files": ["test/autosave/recovery.test.ts"],
      "testCategories": ["unit"],
      "acceptanceCriteria": [
        "Tests for checkForRecovery with no draft",
        "Tests for checkForRecovery with valid draft",
        "Tests for stale draft cleanup (>7 days)",
        "Tests for promptRecovery accept/decline",
        "Tests for error handling on store read failure",
        "80%+ coverage"
      ]
    },
    {
      "id": "3.2.8",
      "category": "documentation",
      "title": "Update documentation and commit",
      "description": "Update CHANGELOG with autosave feature, update ROADMAP status, and commit all changes.",
      "status": "completed",
      "implementationNotes": "CHANGELOG updated with Sprint 2 details (21 tests). ROADMAP Auto-Save/Recovery marked completed (2026-01-27). Sprint JSON updated with accurate implementation notes. Total test count updated to 217.",
      "estimatedHours": 0.1,
      "files": ["CHANGELOG.md", "docs/planning/ROADMAP.md"],
      "testCategories": ["manual"],
      "acceptanceCriteria": [
        "CHANGELOG updated with autosave feature details",
        "ROADMAP shows Auto-Save / Recovery as completed",
        "Changes committed to GitHub"
      ]
    }
  ],
  "successCriteria": [
    "Drafts automatically saved every 30 seconds when content changes",
    "Recovery prompt shown on startup if unsaved draft exists",
    "User can accept or discard recovered draft",
    "Manual save clears draft data",
    "Stale drafts older than 7 days are cleaned up",
    "Status bar shows brief 'Draft saved' indicator",
    "All unit tests pass with 80%+ coverage",
    "No regression in existing 196 tests"
  ],
  "filesCreated": [
    "src/autosave/constants.ts",
    "src/autosave/manager.ts",
    "src/autosave/recovery.ts",
    "test/autosave/manager.test.ts",
    "test/autosave/recovery.test.ts"
  ],
  "filesModified": [
    "src/main.ts",
    "src/toolbar/actions.ts",
    "CHANGELOG.md",
    "docs/planning/ROADMAP.md"
  ],
  "totalNewTests": 21,
  "totalEstimatedHours": 1.25,
  "dependencies": ["Phase 3 Sprint 1 complete", "Tauri Store plugin available"],
  "storeKeys": {
    "draftContent": "The editor content saved periodically",
    "draftTimestamp": "ISO 8601 timestamp of last autosave",
    "draftFilePath": "File path at time of autosave (or null for unsaved)"
  },
  "notes": [
    "Uses existing Tauri Store plugin (settings.store) - no new dependencies",
    "Reuses debounce utility from src/utils/debounce.ts",
    "30-second interval balances data safety vs store write frequency",
    "Recovery prompt uses @tauri-apps/plugin-dialog confirm dialog",
    "Draft cleared on manual save to avoid false recovery prompts",
    "Stale drafts (>7 days) auto-cleaned to prevent store bloat"
  ]
}
